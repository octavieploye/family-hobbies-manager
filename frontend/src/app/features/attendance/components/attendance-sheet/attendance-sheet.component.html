<!-- attendance-sheet.component.html -->
<div class="attendance-sheet">
  <h1 class="attendance-sheet__title">Feuille de pr&eacute;sence</h1>

  <!-- Session Selection -->
  <div class="attendance-sheet__controls">
    <mat-form-field appearance="outline">
      <mat-label>ID de la s&eacute;ance</mat-label>
      <input matInput type="number" [formControl]="sessionIdControl" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Date</mat-label>
      <input matInput type="date" [formControl]="dateControl" />
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="onLoadSession()" aria-label="Charger la s&eacute;ance">
      <mat-icon>search</mat-icon>
      Charger
    </button>
  </div>

  <!-- Loading -->
  @if (loading$ | async) {
    <div class="attendance-sheet__loading">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Chargement des pr&eacute;sences...</p>
    </div>
  } @else {
    <!-- Error -->
    @if (error$ | async; as error) {
      <div class="attendance-sheet__error" role="alert">
        <mat-icon>error_outline</mat-icon>
        <p>{{ error }}</p>
      </div>
    }

    <!-- Attendance Table -->
    @if ((records$ | async); as records) {
      @if (records.length === 0) {
        <div class="attendance-sheet__empty">
          <mat-icon>event_busy</mat-icon>
          <p>Aucune pr&eacute;sence trouv&eacute;e pour cette s&eacute;ance.</p>
        </div>
      } @else {
        <table mat-table [dataSource]="records" class="attendance-sheet__table">
          <!-- Member Name Column -->
          <ng-container matColumnDef="memberName">
            <th mat-header-cell *matHeaderCellDef>Membre</th>
            <td mat-cell *matCellDef="let record">
              {{ record.memberFirstName }} {{ record.memberLastName }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Statut</th>
            <td mat-cell *matCellDef="let record">
              <mat-form-field appearance="outline" class="attendance-sheet__status-field">
                <mat-select
                  [value]="getEffectiveStatus(record)"
                  (selectionChange)="onStatusChange(record, $event.value)"
                >
                  @for (status of statusOptions; track status) {
                    <mat-option [value]="status">
                      <mat-icon [style.color]="getStatusColor(status)">{{ getStatusIcon(status) }}</mat-icon>
                      {{ getStatusLabel(status) }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Note Column -->
          <ng-container matColumnDef="note">
            <th mat-header-cell *matHeaderCellDef>Note</th>
            <td mat-cell *matCellDef="let record">
              <mat-form-field appearance="outline" class="attendance-sheet__note-field">
                <input
                  matInput
                  [value]="getEffectiveNote(record)"
                  (input)="onNoteChange(record, $any($event.target).value)"
                  placeholder="Note optionnelle"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Bulk Save Button -->
        <div class="attendance-sheet__actions">
          <button
            mat-raised-button
            color="accent"
            [disabled]="!hasChanges()"
            (click)="onBulkSave(records)"
            aria-label="Enregistrer toutes les pr&eacute;sences"
          >
            <mat-icon>save</mat-icon>
            Enregistrer les pr&eacute;sences
          </button>
        </div>
      }
    }
  }
</div>
